generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MERCHANDISER
  RETAILER
}

model User {
  id        String   @id @default(cuid())
  name      String
  phone     String   @unique
  role      UserRole
  shopName  String?
  address   String?
  createdAt DateTime @default(now())

  inventoryBatch InventoryBatch[]

  retailerOrders     Order[]           @relation("RetailerOrders")
  merchandiserOrders Order[]           @relation("MerchandiserOrders")
  retailerStock      RetailerStock[]   @relation("RetailerStock")
  dailySales         DailySale[]       @relation("RetailerDailySales")
  isActive           Boolean           @default(true)
  retailerScore      RetailerScore[]
  notificationLog    NotificationLog[]
}

model Product {
  id               String            @id @default(cuid())
  name             String
  brand            String
  category         String
  unit             String
  createdAt        DateTime          @default(now())
  batches          InventoryBatch[]
  retailerStock    RetailerStock[]
  dailySale        DailySale[]
  ProductAnalytics ProductAnalytics?
  retailerScore    RetailerScore[]
}

model InventoryBatch {
  id              String            @id @default(cuid())
  productId       String
  product         Product           @relation(fields: [productId], references: [id])
  merchandiserId  String
  merchandiser    User              @relation(fields: [merchandiserId], references: [id])
  quantity        Int
  purchasePrice   Float
  sellingPrice    Float
  expiryDate      DateTime
  createdAt       DateTime          @default(now())
  orderItem       OrderItem[]
  notificationLog NotificationLog[]

  @@index([expiryDate])
  @@index([productId])
}

model Order {
  id String @id @default(cuid())

  retailerId     String
  retailer       User        @relation("RetailerOrders", fields: [retailerId], references: [id])
  merchandiserId String
  merchandiser   User        @relation("MerchandiserOrders", fields: [merchandiserId], references: [id])
  createdAt      DateTime    @default(now())
  status         String      @default("COMPLETED")
  items          OrderItem[]
  idempotencyKey String?     @unique

  @@index([retailerId])
  @@index([merchandiserId])
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  order            Order          @relation(fields: [orderId], references: [id])
  inventoryBatchId String
  inventoryBatch   InventoryBatch @relation(fields: [inventoryBatchId], references: [id])
  quantity         Int
  price            Float
}

model RetailerStock {
  id         String   @id @default(cuid())
  retailerId String
  retailer   User     @relation("RetailerStock", fields: [retailerId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([retailerId, productId])
}

model DailySale {
  id String @id @default(cuid())

  retailerId String
  retailer   User    @relation("RetailerDailySales", fields: [retailerId], references: [id])
  productId  String
  product    Product @relation(fields: [productId], references: [id])

  quantity Int
  date     DateTime @default(now())

  @@unique([retailerId, productId, date])
  @@index([retailerId, productId])
  @@index([date])
}

model ProductAnalytics {
  id                   String   @id @default(cuid())
  productId            String   @unique
  product              Product  @relation(fields: [productId], references: [id])
  avgDaysToSell        Float    @default(30)
  sellVelocityPerDay   Float    @default(0)
  stdDevDays           Float    @default(7)
  dynamicThresholdDays Int      @default(24)
  lastComputedAt       DateTime @default(now())
}

model RetailerScore {
  id                     String   @id @default(cuid())
  retailerId             String
  retailer               User     @relation(fields: [retailerId], references: [id])
  productId              String
  product                Product  @relation(fields: [productId], references: [id])
  purchaseFrequencyScore Float    @default(0)
  volumeScore            Float    @default(0)
  recencyScore           Float    @default(0)
  sellThroughScore       Float    @default(0)
  reliabilityScore       Float    @default(0)
  compositeScore         Float    @default(0)
  lastUpdated            DateTime @default(now())

  @@unique([retailerId, productId])
}

model NotificationLog {
  id               String         @id @default(cuid())
  retailerId       String
  retailer         User           @relation(fields: [retailerId], references: [id])
  inventoryBatchId String
  inventoryBatch   InventoryBatch @relation(fields: [inventoryBatchId], references: [id])
  urgencyScore     Float
  retailerRank     Int
  sentAt           DateTime       @default(now())
  viewedAt         DateTime?
  orderedAt        DateTime?
  outcome          String         @default("pending")
}
